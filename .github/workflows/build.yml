# vi: ts=2 sw=2 ff=unix fenc=utf-8
name: Build and Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

# Taskfile.yml の vars セクションと対応する定数
env:
  SRC_DIR: /tmp/busybox-w32
  BUILD_DIR: /tmp/busybox-nt-build
  DEFCONFIG: mingw64u_defconfig

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check for new upstream tag
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # git ls-remote で上流リポジトリから最新の FRP-* タグを取得（API レート制限を消費しない）
          LATEST_TAG=$(git ls-remote --tags \
            https://github.com/rmyorston/busybox-w32.git 'refs/tags/FRP-*' \
            | sed 's|.*refs/tags/||' | grep -v '\^{}' | sort -t'-' -k2,2 -n | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "ERROR: FRP タグが見つからない" >&2
            exit 1
          fi

          # FRP- プレフィックスを除去してリリースバージョン文字列を算出
          VERSION="${LATEST_TAG#FRP-}"
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # 自リポに同バージョンのリリースが既に存在するかチェック
          if gh release view "$VERSION" --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "既にリリース済み ($VERSION)、スキップ"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "新バージョン検出: $VERSION"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install build dependencies
        if: steps.check.outputs.skip == 'false'
        run: sudo apt-get install -y gcc-mingw-w64-x86-64 zip

      - name: Clone and checkout busybox-w32
        if: steps.check.outputs.skip == 'false'
        run: |
          git clone https://github.com/rmyorston/busybox-w32.git "$SRC_DIR"
          git -C "$SRC_DIR" checkout "${{ steps.check.outputs.latest_tag }}"

      - name: Build
        if: steps.check.outputs.skip == 'false'
        run: |
          mkdir -p "$BUILD_DIR"
          make -C "$SRC_DIR" O="$BUILD_DIR" "$DEFCONFIG"
          sed -i 's/^CONFIG_EXTRA_CFLAGS=.*/CONFIG_EXTRA_CFLAGS="-O2"/' "$BUILD_DIR/.config"
          make -C "$SRC_DIR" O="$BUILD_DIR" -j$(nproc)

      - name: Create release archive
        if: steps.check.outputs.skip == 'false'
        id: archive
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          ZIP_NAME="busybox-${VERSION}_x64.zip"
          zip -j "$ZIP_NAME" "$BUILD_DIR/busybox.exe"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.check.outputs.version }}" \
            "${{ steps.archive.outputs.zip_name }}" \
            --title "${{ steps.check.outputs.version }}" \
            --notes "" \
            --repo "${{ github.repository }}"
