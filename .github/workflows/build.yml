# vi: ts=2 sw=2 ff=unix fenc=utf-8
name: Build and Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for new upstream tag
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 上流リポジトリから最新の FRP-* タグを取得
          LATEST_TAG=$(gh api repos/rmyorston/busybox-w32/tags --paginate \
            --jq '.[].name' | grep '^FRP-' | sort -t'-' -k2,2 -n | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "ERROR: FRP タグが見つからない" >&2
            exit 1
          fi

          # FRP- プレフィックスを除去してリリースバージョン文字列を算出
          VERSION="${LATEST_TAG#FRP-}"
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # 自リポに同バージョンのリリースが既に存在するかチェック
          if gh release view "$VERSION" > /dev/null 2>&1; then
            echo "既にリリース済み ($VERSION)、スキップ"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "新バージョン検出: $VERSION"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install build dependencies
        if: steps.check.outputs.skip == 'false'
        run: sudo apt-get install -y gcc-mingw-w64-x86-64 zip

      - name: Clone and checkout busybox-w32
        if: steps.check.outputs.skip == 'false'
        run: |
          git clone https://github.com/rmyorston/busybox-w32.git /tmp/busybox-w32
          git -C /tmp/busybox-w32 checkout "${{ steps.check.outputs.latest_tag }}"

      - name: Build
        if: steps.check.outputs.skip == 'false'
        run: |
          mkdir -p /tmp/busybox-nt-build
          make -C /tmp/busybox-w32 O=/tmp/busybox-nt-build mingw64u_defconfig
          sed -i 's/^CONFIG_EXTRA_CFLAGS=.*/CONFIG_EXTRA_CFLAGS="-O2"/' /tmp/busybox-nt-build/.config
          make -C /tmp/busybox-w32 O=/tmp/busybox-nt-build -j$(nproc)

      - name: Create release archive
        if: steps.check.outputs.skip == 'false'
        id: archive
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          ZIP_NAME="busybox-${VERSION}_x64.zip"
          zip -j "$ZIP_NAME" /tmp/busybox-nt-build/busybox.exe
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          ZIP_NAME="${{ steps.archive.outputs.zip_name }}"
          gh release create "$VERSION" "$ZIP_NAME" --title "$VERSION" --notes ""
